<link rel="import" href="../bower_components/polymer/polymer.html">
<link href="../bower_components/vaadin-components/vaadin-grid/vaadin-grid.html" rel="import">
<dom-module id="loan-list">
  <style>
  </style>
  <template>
    <div>Device on Loan</div>
    <v-grid selection-mode="single" id="loangrid">
      <table>
        <colgroup>
          <col header-text="Device">
          <col header-text="Borrower">
          <col header-text="Signature">
          <col header-text="Check Out Date">
        </colgroup>
        <tbody>
        <template is="dom-repeat" items="{{loans}}">
          <tr>
            <td><span>{{item.dev_name}}</span> (<span>{{item.dev_id}}</span>)</td>
            <td>{{item.user_id}}</td>
            <td><img src="{{item.user_signature}}" width="200"/></td>
            <td>{{item.checkout_date}}</td>
          </tr>
        </template>
        </tbody>
      </table>
    </v-grid>
  </template>
</dom-module>
<script>
  Polymer({
    is: "loan-list",
    properties: {
      loans: Array
    },
    ready: function () {
      var loanObj = Parse.Object.extend("DevOut");
      var query = new Parse.Query(loanObj);

      /* use Parse.Promise */
      query.find().then(function (results) {
        var promises = [];

        results.forEach(function (loanObj) {
          /* TODO: move the table and query declaration out of the loop? */
          var devTable = Parse.Object.extend("Devices");
          var devQuery = new Parse.Query(devTable);
          var devId = loanObj.get("device_obj");

          /* pass the result of the DevOut query as a resolved promise */
          promises.push (Parse.Promise.as(loanObj));

          /* create a new promise for querying the device object */
          promises.push (devQuery.get(devId.id));
        });
        return Parse.Promise.when(promises);
      }).then(function() {
        this.loans = [];
        for (var k = 0; k < arguments.length/2; k++) {
          var loanObj = arguments[2*k];
          var devObj = arguments[2*k+1];
          var photo = loanObj.get("signature");
          this.push('loans', {
            dev_id: devObj.get("device_id"),
            dev_name: devObj.get("name"),
            user_id: loanObj.get('user_id'),
            user_signature: photo.url(),
            checkout_date: loanObj.createdAt.toDateString()
          });
        }
        return Parse.Promise.as(true);
      }.bind(this)).fail(function (err) {
        console.log("Fail to load loan information", err);
      });
    }
  });
</script>