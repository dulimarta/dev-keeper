<link rel="import" href="../bower_components/polymer/polymer.html">
<link href="../bower_components/vaadin-components/vaadin-grid/vaadin-grid.html" rel="import">
<dom-module id="loan-list">
  <style>
  </style>
  <template>
    <div>Device on Loan</div>
    <v-grid selection-mode="single" id="loangrid">
      <table>
        <colgroup>
          <col header-text="Device">
          <col header-text="Borrower">
          <col header-text="Signature">
          <col header-text="Check Out Date">
        </colgroup>
        <tbody>
        <template is="dom-repeat" items="{{loans}}">
          <tr>
            <td><span>{{item.devname}}</span> (<span>{{item.devid}}</span>)</td>
            <td><span>{{item.username}}</span> [<span>{{item.userid}}</span></td>
            <td><img src="{{item.usersignature}}" width="200"/></td>
            <td>{{item.checkoutdate}}</td>
          </tr>
        </template>
        </tbody>
      </table>
    </v-grid>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'loan-list',
    properties: {
      loans: Array
    },
    ready: function () {
      var loanObj = Parse.Object.extend('DevOut');
      var query = new Parse.Query(loanObj);
      var devTable = Parse.Object.extend('Devices');
      var devQuery = new Parse.Query(devTable);
      var userTable = Parse.Object.extend('Users');
      var userQuery = new Parse.Query(userTable);

      /* use Parse.Promise */
      query.find().then(function (results) {
        var promises = [];

        results.forEach(function (loanObj) {
          /* TODO: move the table and query declaration out of the loop? */
          var devId = loanObj.get('device_obj');
          var userId = loanObj.get('user_obj');

          /* pass the result of the DevOut query as a resolved promise */
          promises.push (Parse.Promise.as(loanObj));

          /* create a new promise for querying the device and user objects */
          promises.push (devQuery.get(devId.id));
          promises.push (userQuery.get(userId.id));
        });
        return Parse.Promise.when(promises);
      }).then(function() {
        this.loans = [];
        for (var k = 0; k < arguments.length/3; k++) {
          /* the implicit variable "arguments" is the incoming parameter
             of this function.
           */
          var loanObj = arguments[3*k];
          var devObj = arguments[3*k + 1];
          var userObj = arguments[3*k + 2];
          var photo = loanObj.get('signature');
          this.push('loans', {
            devid: devObj.get('device_id'),
            devname: devObj.get('name'),
            userid: loanObj.get('user_id'),
            username: userObj.get('user_name'),
            usersignature: photo.url(),
            checkoutdate: loanObj.createdAt.toDateString()
          });
        }
        return Parse.Promise.as(true);
      }.bind(this)).fail(function (err) {
        console.log('Fail to load loan information', err);
      });
    }
  });
</script>
